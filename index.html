<!DOCTYPE html>
<html>

<head>
    <title>Doctors Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
        }

        #sidebar {
            width: 300px;
            height: 100vh;
            background: #fff;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            font-family: Arial, sans-serif;
            flex-shrink: 0;
        }

        #sidebar-header {
            padding: 12px;
            background: #4285f4;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        #sidebar-list {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .sidebar-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }

        .sidebar-item:hover {
            background: #f5f5f5;
        }

        .sidebar-item.active {
            background: #e3f2fd;
            border-left: 3px solid #4285f4;
        }

        .sidebar-item-name {
            font-weight: bold;
            color: #1a0dab;
            margin-bottom: 4px;
        }

        .sidebar-item-name a {
            color: #1a0dab;
            text-decoration: none;
        }

        .sidebar-item-name a:hover {
            text-decoration: underline;
        }

        .sidebar-item-description {
            font-size: 12px;
            color: #333;
            margin-bottom: 4px;
        }

        .sidebar-item-address {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .sidebar-item-phone {
            font-size: 12px;
            color: #4285f4;
            margin-bottom: 4px;
        }

        .sidebar-item-phone a {
            color: #4285f4;
            text-decoration: none;
        }

        .sidebar-item-programs {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .sidebar-item-links {
            font-size: 12px;
            margin-top: 6px;
        }

        .sidebar-item-links a {
            margin-right: 10px;
            text-decoration: none;
        }

        .sidebar-item-count {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
        }

        #map {
            flex: 1;
            height: 100vh;
        }

        #update-info {
            position: absolute;
            bottom: 10px;
            left: 310px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            font-size: 12px;
            color: #333;
            z-index: 1000;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        #lang-switcher {
            position: absolute;
            bottom: 35px;
            left: 310px;
            background: rgba(255, 255, 255, 0.95);
            padding: 3px;
            border-radius: 3px;
            font-family: Arial, sans-serif;
            font-size: 10px;
            z-index: 1000;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            display: flex;
            gap: 0;
        }

        #lang-switcher button {
            padding: 4px 8px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s;
        }

        #lang-switcher button:first-child {
            border-radius: 3px 0 0 3px;
        }

        #lang-switcher button:last-child {
            border-radius: 0 3px 3px 0;
            border-left: none;
        }

        #lang-switcher button.active {
            background: #4285f4;
            color: white;
            border-color: #4285f4;
        }

        #lang-switcher button:hover:not(.active) {
            background: #f0f0f0;
        }

        #search-container {
            position: absolute;
            top: 10px;
            left: 360px;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            #search-container {
                left: 50px;
            }
        }

        #search-input {
            width: 250px;
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            font-family: Arial, sans-serif;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        #search-input:focus {
            border-color: #4285f4;
            box-shadow: 0 1px 3px rgba(66,133,244,0.3);
        }

        #search-input::placeholder {
            color: #999;
        }

        #search-count {
            position: absolute;
            top: 50px;
            left: 50px;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: Arial, sans-serif;
            font-size: 12px;
            color: #666;
            z-index: 1000;
            display: none;
        }

        @media (max-width: 768px) {
            body {
                display: block;
            }
            #sidebar {
                display: none;
            }
            #map {
                width: 100%;
                height: 100vh;
            }
            #lang-switcher {
                bottom: 30px;
                left: 10px;
            }
            #update-info {
                left: 10px;
            }
            #search-container {
                left: 50px;
            }
        }
    </style>
</head>

<body>
    <div id="sidebar">
        <div id="sidebar-header">Doctors on screen: 0</div>
        <ul id="sidebar-list"></ul>
    </div>
    <div id="map"></div>
    <div id="search-container">
        <input type="text" id="search-input" placeholder="Search name, address, phone...">
    </div>
    <div id="search-count"></div>
    <div id="lang-switcher">
        <button id="btn-en" onclick="switchLanguage('EN')">EN</button>
        <button id="btn-tc" onclick="switchLanguage('TC')">繁中</button>
    </div>
    <div id="update-info">Loading...</div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Initialize map
        var map = L.map('map').setView([22.28, 114.15], 13);
        var markersLayer = L.layerGroup().addTo(map);
        var currentLang = localStorage.getItem('preferredLang') || 'EN';
        var allDoctors = []; // Store all doctors for filtering
        var currentGroups = []; // Store current marker groups
        var markerMap = {}; // Map group index to marker
        var selectedGroupIndex = null; // Currently selected group in sidebar
        var isNavigating = false; // Flag to prevent sidebar updates during navigation

        // Translations
        var i18n = {
            EN: {
                searchPlaceholder: 'Search name, address, phone...',
                viewInMaps: 'View in Google Maps',
                getDirections: 'Get Directions',
                dataUpdated: 'Data updated',
                doctors: 'Doctors',
                found: 'Found',
                of: 'of',
                loading: 'Loading...',
                errorLoading: 'Error loading data',
                fallback: '(EN fallback)',
                doctorsOnScreen: 'Doctors on screen',
                doctorsAtLocation: 'Doctors at this location',
                andMore: 'and {n} more'
            },
            TC: {
                searchPlaceholder: '搜尋名稱、地址、電話...',
                viewInMaps: '在Google地圖查看',
                getDirections: '取得路線',
                dataUpdated: '資料更新',
                doctors: '醫生數目',
                found: '找到',
                of: '/',
                loading: '載入中...',
                errorLoading: '載入資料時出錯',
                fallback: '(英文版本)',
                doctorsOnScreen: '畫面上的醫生',
                doctorsAtLocation: '此位置的醫生',
                andMore: '及其他 {n} 位'
            }
        };

        function t(key) {
            return i18n[currentLang][key] || i18n['EN'][key];
        }

        // Generate sidebar item HTML for a single doctor
        function getDoctorSidebarHtml(d) {
            var searchQuery = d.Name + ", " + d.Address;
            var mapsLink = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(searchQuery);
            var directionsLink = "https://www.google.com/maps/dir/?api=1&destination=" + encodeURIComponent(d.Address);

            var nameHtml = d.ProfileLink
                ? '<a href="' + d.ProfileLink + '" target="_blank" onclick="event.stopPropagation();">' + d.Name + '</a>'
                : d.Name;

            var html = '<div class="sidebar-item-name">' + nameHtml + '</div>';

            if (d.Description) {
                html += '<div class="sidebar-item-description">' + d.Description + '</div>';
            }

            html += '<div class="sidebar-item-address">' + (d.Address || '') + '</div>';

            if (d.Phone) {
                html += '<div class="sidebar-item-phone"><a href="tel:' + d.Phone + '" onclick="event.stopPropagation();">' + d.Phone + '</a></div>';
            }

            if (d.Programs) {
                html += '<div class="sidebar-item-programs">' + d.Programs.split('; ').join('<br>') + '</div>';
            }

            html += '<div class="sidebar-item-links">' +
                '<a href="' + mapsLink + '" target="_blank" onclick="event.stopPropagation();" style="color:blue;">' + t('viewInMaps') + '</a>' +
                '<a href="' + directionsLink + '" target="_blank" onclick="event.stopPropagation();" style="color:green;">' + t('getDirections') + '</a>' +
                '</div>';

            return html;
        }

        // Navigate to a doctor's marker and open popup
        function navigateToDoctor(d) {
            // Find the group containing this doctor
            for (var i = 0; i < currentGroups.length; i++) {
                var group = currentGroups[i];
                for (var j = 0; j < group.doctors.length; j++) {
                    if (group.doctors[j].Name === d.Name &&
                        group.doctors[j].Address === d.Address &&
                        group.doctors[j].Phone === d.Phone) {
                        var marker = markerMap[i];
                        if (marker) {
                            isNavigating = true;
                            selectedGroupIndex = i;

                            // Highlight sidebar items for this group
                            var items = document.querySelectorAll('.sidebar-item');
                            items.forEach(function(item) { item.classList.remove('active'); });

                            var targetZoom = Math.max(map.getZoom(), 15);
                            var targetLatLng = [group.lat, group.lon];

                            // Check if we're already at the location
                            var currentCenter = map.getCenter();
                            var currentZoom = map.getZoom();
                            var distance = getDistanceMeters(currentCenter.lat, currentCenter.lng, group.lat, group.lon);

                            if (distance < 10 && currentZoom >= targetZoom) {
                                // Already at location, just open popup
                                marker.openPopup();
                                isNavigating = false;
                            } else {
                                // Move to location, then open popup
                                map.once('moveend', function() {
                                    setTimeout(function() {
                                        marker.openPopup();
                                        isNavigating = false;
                                    }, 50);
                                });
                                map.setView(targetLatLng, targetZoom);
                            }
                        }
                        return;
                    }
                }
            }
        }

        // Update sidebar with doctors
        function updateSidebar(doctors, headerText) {
            var header = document.getElementById('sidebar-header');
            var list = document.getElementById('sidebar-list');

            header.textContent = headerText || (t('doctorsOnScreen') + ': ' + doctors.length);
            list.innerHTML = '';

            doctors.forEach(function(d, index) {
                var li = document.createElement('li');
                li.className = 'sidebar-item';
                li.innerHTML = getDoctorSidebarHtml(d);

                li.onclick = function(e) {
                    // Don't navigate if clicking on a link
                    if (e.target.tagName === 'A') return;
                    navigateToDoctor(d);
                };

                list.appendChild(li);
            });
        }

        // Update sidebar with visible doctors on screen
        function updateSidebarWithVisibleDoctors() {
            if (selectedGroupIndex !== null || isNavigating) return; // Don't update if showing a specific group or navigating

            var bounds = map.getBounds();
            var visibleDoctors = [];

            currentGroups.forEach(function(group) {
                if (bounds.contains([group.lat, group.lon])) {
                    group.doctors.forEach(function(d) {
                        visibleDoctors.push(d);
                    });
                }
            });

            updateSidebar(visibleDoctors);
        }

        // Show doctors from a specific marker group
        function showGroupInSidebar(groupIndex) {
            selectedGroupIndex = groupIndex;
            var group = currentGroups[groupIndex];
            if (group) {
                updateSidebar(group.doctors, t('doctorsAtLocation') + ': ' + group.doctors.length);

                // Highlight active items
                var items = document.querySelectorAll('.sidebar-item');
                items.forEach(function(item) {
                    item.classList.add('active');
                });
            }
        }

        // Reset sidebar to show all visible doctors
        function resetSidebar() {
            selectedGroupIndex = null;
            isNavigating = false;
            updateSidebarWithVisibleDoctors();
        }

        // Use Google Maps Tiles (Standard Roadmap)
        L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            attribution: '© Google'
        }).addTo(map);

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Filter doctors based on search query
        function filterDoctors(query) {
            if (!query.trim()) {
                document.getElementById('search-count').style.display = 'none';
                addMarkers(allDoctors);
                return;
            }

            const searchTerm = query.toLowerCase();
            const filtered = allDoctors.filter(d => {
                const name = (d.Name || '').toLowerCase();
                const address = (d.Address || '').toLowerCase();
                const phone = (d.Phone || '').toLowerCase();
                return name.includes(searchTerm) ||
                       address.includes(searchTerm) ||
                       phone.includes(searchTerm);
            });

            addMarkers(filtered);

            // Show result count
            const countEl = document.getElementById('search-count');
            countEl.textContent = `${t('found')}: ${filtered.length} ${t('of')} ${allDoctors.length}`;
            countEl.style.display = 'block';
        }

        // Debounced search handler (300ms delay)
        const handleSearch = debounce(function(e) {
            filterDoctors(e.target.value);
        }, 300);

        // Attach search event listener
        document.getElementById('search-input').addEventListener('input', handleSearch);

        // Update language switcher UI
        function updateLangButtons() {
            document.getElementById('btn-en').classList.toggle('active', currentLang === 'EN');
            document.getElementById('btn-tc').classList.toggle('active', currentLang === 'TC');
        }

        // Switch language and reload data
        function switchLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('preferredLang', lang);
            updateLangButtons();
            updateSearchPlaceholder();
            document.getElementById('search-input').value = '';
            document.getElementById('search-count').style.display = 'none';
            loadDoctorsData();
        }

        // Update search placeholder based on language
        function updateSearchPlaceholder() {
            document.getElementById('search-input').placeholder = t('searchPlaceholder');
        }

        // Function to parse CSV text into array of objects
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = parseCSVLine(lines[0]);
            const doctors = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const doctor = {};
                headers.forEach((header, index) => {
                    let value = values[index] || '';
                    // Convert Lat and Lon to numbers
                    if (header === 'Lat' || header === 'Lon') {
                        value = parseFloat(value) || 0;
                    }
                    doctor[header] = value;
                });
                doctors.push(doctor);
            }
            return doctors;
        }

        // Parse a single CSV line, handling quoted fields
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            // Remove carriage returns (handle CRLF line endings)
            line = line.replace(/\r/g, '');

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // Calculate distance between two coordinates in meters (Haversine formula)
        function getDistanceMeters(lat1, lon1, lat2, lon2) {
            var R = 6371000; // Earth's radius in meters
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLon = (lon2 - lon1) * Math.PI / 180;
            var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Group doctors by proximity (within threshold meters)
        function groupDoctorsByProximity(doctors, thresholdMeters) {
            var groups = [];

            doctors.forEach(function (d) {
                if (!d.Lat || !d.Lon) return;

                var foundGroup = null;
                for (var i = 0; i < groups.length; i++) {
                    var group = groups[i];
                    var distance = getDistanceMeters(d.Lat, d.Lon, group.lat, group.lon);
                    if (distance <= thresholdMeters) {
                        foundGroup = group;
                        break;
                    }
                }

                if (foundGroup) {
                    foundGroup.doctors.push(d);
                } else {
                    groups.push({
                        lat: d.Lat,
                        lon: d.Lon,
                        doctors: [d]
                    });
                }
            });

            return groups;
        }

        // Generate popup HTML for a single doctor
        function getDoctorPopupHtml(d) {
            var searchQuery = d.Name + ", " + d.Address;
            var mapsLink = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(searchQuery);
            var directionsLink = "https://www.google.com/maps/dir/?api=1&destination=" + encodeURIComponent(d.Address);

            var nameHtml = d.ProfileLink
                ? "<b><a href='" + d.ProfileLink + "' target='_blank' style='color:#1a0dab;text-decoration:none;'>" + d.Name + "</a></b>"
                : "<b>" + d.Name + "</b>";

            return nameHtml + "<br>" +
                (d.Description ? d.Description + "<br>" : "") +
                d.Address + "<br>" +
                (d.Phone ? "<a href='tel:" + d.Phone + "'>" + d.Phone + "</a><br>" : "") +
                (d.Programs ? "<small>" + d.Programs.split('; ').join('<br>') + "</small><br>" : "") +
                "<br><a href='" + mapsLink + "' target='_blank' style='color:blue;'>" + t('viewInMaps') + "</a>" +
                "<br><a href='" + directionsLink + "' target='_blank' style='color:green; font-weight:bold;'>" + t('getDirections') + "</a>";
        }

        // Function to add markers to map
        function addMarkers(doctors) {
            // Clear existing markers
            markersLayer.clearLayers();
            markerMap = {};
            selectedGroupIndex = null;
            var bounds = [];

            // Group doctors within 10 meters of each other
            currentGroups = groupDoctorsByProximity(doctors, 10);

            // Create markers for each group
            currentGroups.forEach(function (group, groupIndex) {
                var marker = L.marker([group.lat, group.lon]).addTo(markersLayer);
                markerMap[groupIndex] = marker;
                var popupContent;

                if (group.doctors.length === 1) {
                    // Single doctor at this location
                    popupContent = getDoctorPopupHtml(group.doctors[0]);
                } else {
                    // Multiple doctors nearby
                    popupContent = "<div style='max-height:300px;overflow-y:auto;'>";
                    group.doctors.forEach(function (d, index) {
                        if (index > 0) {
                            popupContent += "<hr style='margin:10px 0;border:none;border-top:1px solid #ddd;'>";
                        }
                        popupContent += getDoctorPopupHtml(d);
                    });
                    popupContent += "</div>";
                }

                marker.bindPopup(popupContent, { maxWidth: 300, maxHeight: 350 });

                // When marker is clicked, show its doctors in sidebar
                marker.on('click', function() {
                    showGroupInSidebar(groupIndex);
                });

                bounds.push([group.lat, group.lon]);
            });

            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }

            // Update sidebar after markers are added
            setTimeout(updateSidebarWithVisibleDoctors, 100);
        }

        // Extract DPID from ProfileLink
        function getDpidFromLink(link) {
            if (!link) return null;
            var match = link.match(/DPID=(\d+)/);
            return match ? match[1] : null;
        }

        // Apply GPS fallback data to doctors missing coordinates
        function applyGpsFallback(doctors, fallbackData) {
            var fallbackMap = {};
            fallbackData.forEach(function(row) {
                if (row.DPID && row.Lat && row.Lon) {
                    fallbackMap[row.DPID] = { Lat: parseFloat(row.Lat), Lon: parseFloat(row.Lon) };
                }
            });

            doctors.forEach(function(d) {
                if (!d.Lat || !d.Lon) {
                    var dpid = getDpidFromLink(d.ProfileLink);
                    if (dpid && fallbackMap[dpid]) {
                        d.Lat = fallbackMap[dpid].Lat;
                        d.Lon = fallbackMap[dpid].Lon;
                    }
                }
            });

            return doctors;
        }

        // Fetch and load the CSV file with fallback
        function loadDoctorsData() {
            const csvFile = currentLang === 'TC' ? 'doctors_tc.csv' : 'doctors.csv';
            const updateInfo = document.getElementById('update-info');
            updateInfo.textContent = t('loading');

            fetch(csvFile)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('File not found');
                    }
                    const lastModified = response.headers.get('Last-Modified');
                    return response.text().then(text => ({ text, lastModified, usedFallback: false }));
                })
                .catch(() => {
                    // Fallback to English version if TC not found
                    if (currentLang === 'TC') {
                        console.log('doctors_tc.csv not found, falling back to doctors.csv');
                        return fetch('doctors.csv').then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to load doctors.csv');
                            }
                            const lastModified = response.headers.get('Last-Modified');
                            return response.text().then(text => ({ text, lastModified, usedFallback: true }));
                        });
                    }
                    throw new Error('Failed to load doctors.csv');
                })
                .then(({ text, lastModified, usedFallback }) => {
                    allDoctors = parseCSV(text);

                    // For TC version, load GPS fallback for doctors missing coordinates
                    if (currentLang === 'TC' && !usedFallback) {
                        return fetch('gps_fallback.csv')
                            .then(response => response.ok ? response.text() : '')
                            .then(fallbackText => {
                                if (fallbackText) {
                                    var fallbackData = parseCSV(fallbackText);
                                    allDoctors = applyGpsFallback(allDoctors, fallbackData);
                                }
                                return { lastModified, usedFallback };
                            });
                    }
                    return { lastModified, usedFallback };
                })
                .then(({ lastModified, usedFallback }) => {
                    addMarkers(allDoctors);

                    // Display update date
                    let dateStr = '';
                    if (lastModified) {
                        const date = new Date(lastModified);
                        const locale = currentLang === 'TC' ? 'zh-TW' : 'en-US';
                        const formatted = date.toLocaleDateString(locale, {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        dateStr = t('dataUpdated') + ': ' + formatted;
                    } else {
                        dateStr = t('doctors') + ': ' + allDoctors.length;
                    }

                    if (usedFallback) {
                        dateStr += ' ' + t('fallback');
                    }
                    updateInfo.textContent = dateStr;
                })
                .catch(error => {
                    console.error('Error loading doctors data:', error);
                    updateInfo.textContent = t('errorLoading');
                });
        }

        // Update sidebar when map is moved or zoomed
        map.on('moveend', updateSidebarWithVisibleDoctors);

        // Reset sidebar when popup is closed
        map.on('popupclose', resetSidebar);

        // Initialize on page load
        updateLangButtons();
        updateSearchPlaceholder();
        loadDoctorsData();
    </script>
</body>

</html>
